# Django API ê°œë°œ ìš”ì²­ì‚¬í•­ (2025-11-17)

## ğŸ“‹ ê°œìš”
Game Honey ë¯¸ë‹ˆì•±ì˜ í† ìŠ¤ ë¡œê·¸ì¸ ë° API ì—°ë™ì„ ìœ„í•´ Django ë°±ì—”ë“œì— ë‹¤ìŒ ê¸°ëŠ¥ë“¤ì´ í•„ìš”í•©ë‹ˆë‹¤.

---

## ğŸ” 1. CORS ì„¤ì • (ìµœìš°ì„ )

### ë¬¸ì œ ìƒí™©
í˜„ì¬ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ Django API í˜¸ì¶œ ì‹œ `ERR_NETWORK` (HTTP Status: 0) ì—ëŸ¬ ë°œìƒ

### í•´ê²° ë°©ë²•
`settings.py`ì— CORS ì„¤ì • ì¶”ê°€:

```python
# settings.py

# django-cors-headers ì„¤ì¹˜ í•„ìš”
# pip install django-cors-headers

INSTALLED_APPS = [
    ...
    'corsheaders',
    ...
]

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',  # ìµœìƒë‹¨ì— ìœ„ì¹˜
    'django.middleware.common.CommonMiddleware',
    ...
]

# ì•±ì¸í† ìŠ¤ ë„ë©”ì¸ í—ˆìš©
CORS_ALLOWED_ORIGINS = [
    "https://gamehoney.private-apps.tossmini.com",  # í”„ë¼ì´ë¹— í…ŒìŠ¤íŠ¸ ë„ë©”ì¸
    "https://gamehoney.apps.tossmini.com",           # í”„ë¡œë•ì…˜ ë„ë©”ì¸ (ì¶œì‹œ í›„)
]

# ê°œë°œ ì¤‘ì—ëŠ” ì„ì‹œë¡œ ëª¨ë‘ í—ˆìš© (í”„ë¡œë•ì…˜ì—ì„œëŠ” ì œê±°!)
# CORS_ALLOW_ALL_ORIGINS = True

CORS_ALLOW_CREDENTIALS = True
```

---

## ğŸ”‘ 2. í† ìŠ¤ ë¡œê·¸ì¸ API êµ¬í˜„

### 2.1 mTLS ì¸ì¦ì„œ ì„¤ì •

#### ì¸ì¦ì„œ ë°œê¸‰ ë°©ë²•
1. ì•±ì¸í† ìŠ¤ ì½˜ì†” ì ‘ì†: https://console.apps-in-toss.im
2. Game Honey ì•± ì„ íƒ
3. ì¢Œì¸¡ ë©”ë‰´ "mTLS ì¸ì¦ì„œ" í´ë¦­
4. "+ ë°œê¸‰ë°›ê¸°" ë²„íŠ¼ í´ë¦­
5. `client-cert.pem`, `client-key.pem` ë‹¤ìš´ë¡œë“œ
6. Django í”„ë¡œì íŠ¸ì˜ ì•ˆì „í•œ ìœ„ì¹˜ì— ì €ì¥ (ì˜ˆ: `/etc/ssl/gamehoney/`)

#### Pythonì—ì„œ mTLS ì‚¬ìš© ì˜ˆì œ
```python
import requests

class TossAPIClient:
    def __init__(self):
        self.base_url = "https://apps-in-toss-api.toss.im"
        self.cert_path = "/path/to/client-cert.pem"
        self.key_path = "/path/to/client-key.pem"

    def make_request(self, method, endpoint, data=None, headers=None):
        url = f"{self.base_url}{endpoint}"
        response = requests.request(
            method=method,
            url=url,
            cert=(self.cert_path, self.key_path),
            json=data,
            headers=headers or {'Content-Type': 'application/json'}
        )
        return response.json()
```

### 2.2 í† ìŠ¤ ë¡œê·¸ì¸ API ì—”ë“œí¬ì¸íŠ¸

#### ğŸ“Œ POST `/api/auth/login`
í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë°›ì€ `authorizationCode`ë¥¼ í† ìŠ¤ APIë¡œ ì „ë‹¬í•˜ì—¬ `accessToken` ë°›ê¸°

**ìš”ì²­ (Request)**
```json
{
  "authorizationCode": "string",
  "referrer": "string"  // "sandbox" ë˜ëŠ” "DEFAULT"
}
```

**ì²˜ë¦¬ ë¡œì§**
```python
# views.py
from rest_framework.decorators import api_view
from rest_framework.response import Response
from rest_framework import status

@api_view(['POST'])
def toss_login(request):
    authorization_code = request.data.get('authorizationCode')
    referrer = request.data.get('referrer')

    # 1. í† ìŠ¤ APIì— authorizationCode ì „ì†¡í•˜ì—¬ accessToken ë°›ê¸°
    toss_client = TossAPIClient()
    token_response = toss_client.make_request(
        method='POST',
        endpoint='/api-partner/v1/apps-in-toss/user/oauth2/generate-token',
        data={
            'authorizationCode': authorization_code,
            'referrer': referrer
        }
    )

    # 2. ì‘ë‹µ í˜•ì‹
    # {
    #   "resultType": "SUCCESS",
    #   "success": {
    #     "accessToken": "eyJraWQiOiJjZXJ0...",
    #     "refreshToken": "xNEYPASwWw0n1AxZ...",
    #     "scope": "user_ci user_birthday ...",
    #     "tokenType": "Bearer",
    #     "expiresIn": 3599
    #   }
    # }

    if token_response.get('resultType') != 'SUCCESS':
        return Response(
            {'error': 'Failed to get access token from Toss'},
            status=status.HTTP_400_BAD_REQUEST
        )

    success_data = token_response['success']
    access_token = success_data['accessToken']
    refresh_token = success_data['refreshToken']

    # 3. í† ìŠ¤ APIì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    user_info = toss_client.make_request(
        method='GET',
        endpoint='/api-partner/v1/apps-in-toss/user/oauth2/login-me',
        headers={'Authorization': f"Bearer {access_token}"}
    )

    # 4. ì‘ë‹µ í˜•ì‹
    # {
    #   "resultType": "SUCCESS",
    #   "success": {
    #     "userKey": 443731104,
    #     "scope": "user_ci,user_birthday,...",
    #     "agreedTerms": ["terms_tag1", "terms_tag2"],
    #     "name": "ENCRYPTED_VALUE",
    #     "phone": "ENCRYPTED_VALUE",
    #     ...
    #   }
    # }

    if user_info.get('resultType') != 'SUCCESS':
        return Response(
            {'error': 'Failed to get user info from Toss'},
            status=status.HTTP_400_BAD_REQUEST
        )

    user_data = user_info['success']
    user_key = user_data['userKey']

    # 5. DBì— ì‚¬ìš©ì ì •ë³´ ì €ì¥ ë˜ëŠ” ì—…ë°ì´íŠ¸
    # User ëª¨ë¸ì´ ìˆë‹¤ê³  ê°€ì •
    from .models import User
    user, created = User.objects.update_or_create(
        toss_user_key=user_key,
        defaults={
            'access_token': access_token,
            'refresh_token': refresh_token,
            'scope': user_data.get('scope', ''),
        }
    )

    # 6. í”„ë¡ íŠ¸ì—”ë“œì— ì‘ë‹µ
    return Response({
        'accessToken': access_token,
        'refreshToken': refresh_token,
        'userKey': user_key,
    }, status=status.HTTP_200_OK)
```

**ì‘ë‹µ (Response)**
```json
{
  "accessToken": "eyJraWQiOiJjZXJ0...",
  "refreshToken": "xNEYPASwWw0n1AxZ...",
  "userKey": 443731104
}
```

#### ğŸ“Œ GET `/api/auth/me`
í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ

**ìš”ì²­ í—¤ë”**
```
Authorization: Bearer {accessToken}
```

**ì²˜ë¦¬ ë¡œì§**
```python
@api_view(['GET'])
def get_user_info(request):
    # Authorization í—¤ë”ì—ì„œ accessToken ì¶”ì¶œ
    auth_header = request.headers.get('Authorization')
    if not auth_header or not auth_header.startswith('Bearer '):
        return Response(
            {'error': 'No authorization token provided'},
            status=status.HTTP_401_UNAUTHORIZED
        )

    access_token = auth_header.split(' ')[1]

    # DBì—ì„œ í•´ë‹¹ accessTokenì„ ê°€ì§„ ì‚¬ìš©ì ì°¾ê¸°
    try:
        user = User.objects.get(access_token=access_token)
    except User.DoesNotExist:
        return Response(
            {'error': 'Invalid token'},
            status=status.HTTP_401_UNAUTHORIZED
        )

    # ì‚¬ìš©ì ì •ë³´ ë°˜í™˜
    return Response({
        'userKey': user.toss_user_key,
        'scope': user.scope,
        # í•„ìš”í•œ ë‹¤ë¥¸ ì •ë³´ë“¤...
    }, status=status.HTTP_200_OK)
```

**ì‘ë‹µ (Response)**
```json
{
  "userKey": 443731104,
  "scope": "user_ci user_birthday user_nationality user_name user_phone user_gender"
}
```

#### ğŸ“Œ POST `/api/auth/refresh`
AccessToken ì¬ë°œê¸‰

**ìš”ì²­ (Request)**
```json
{
  "refreshToken": "string"
}
```

**ì²˜ë¦¬ ë¡œì§**
```python
@api_view(['POST'])
def refresh_token(request):
    refresh_token = request.data.get('refreshToken')

    # í† ìŠ¤ APIì— refreshToken ì „ì†¡
    toss_client = TossAPIClient()
    token_response = toss_client.make_request(
        method='POST',
        endpoint='/api-partner/v1/apps-in-toss/user/oauth2/refresh-token',
        data={'refreshToken': refresh_token}
    )

    if token_response.get('resultType') != 'SUCCESS':
        return Response(
            {'error': 'Failed to refresh token'},
            status=status.HTTP_400_BAD_REQUEST
        )

    success_data = token_response['success']
    new_access_token = success_data['accessToken']
    new_refresh_token = success_data['refreshToken']

    # DB ì—…ë°ì´íŠ¸
    User.objects.filter(refresh_token=refresh_token).update(
        access_token=new_access_token,
        refresh_token=new_refresh_token
    )

    return Response({
        'accessToken': new_access_token,
        'refreshToken': new_refresh_token,
    }, status=status.HTTP_200_OK)
```

**ì‘ë‹µ (Response)**
```json
{
  "accessToken": "eyJraWQiOiJjZXJ0...",
  "refreshToken": "xNEYPASwWw0n1AxZ..."
}
```

#### ğŸ“Œ POST `/api/auth/logout`
ë¡œê·¸ì•„ì›ƒ (í† í° ë¬´íš¨í™”)

**ìš”ì²­ í—¤ë”**
```
Authorization: Bearer {accessToken}
```

**ì²˜ë¦¬ ë¡œì§**
```python
@api_view(['POST'])
def logout(request):
    auth_header = request.headers.get('Authorization')
    if not auth_header:
        return Response(status=status.HTTP_200_OK)

    access_token = auth_header.split(' ')[1]

    # í† ìŠ¤ APIì— ë¡œê·¸ì¸ ì—°ê²° ëŠê¸° ìš”ì²­
    toss_client = TossAPIClient()
    toss_client.make_request(
        method='POST',
        endpoint='/api-partner/v1/apps-in-toss/user/oauth2/access/remove-by-access-token',
        headers={'Authorization': f"Bearer {access_token}"}
    )

    # DBì—ì„œ í† í° ì‚­ì œ
    User.objects.filter(access_token=access_token).update(
        access_token=None,
        refresh_token=None
    )

    return Response({'message': 'Logged out successfully'}, status=status.HTTP_200_OK)
```

---

## ğŸ® 3. ê²Œì„ API CORS ìˆ˜ì •

### í˜„ì¬ ìƒí™©
- `GET /api/games/` ì—”ë“œí¬ì¸íŠ¸ëŠ” ì´ë¯¸ ì¡´ì¬
- CORS ì„¤ì •ë§Œ ì¶”ê°€í•˜ë©´ ë™ì‘í•  ê²ƒìœ¼ë¡œ ì˜ˆìƒ

### í™•ì¸ ì‚¬í•­
ê²Œì„ ëª©ë¡ APIê°€ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ëŠ”ì§€ í™•ì¸:

**ì‘ë‹µ í˜•ì‹**
```json
{
  "results": [
    {
      "game_id": "maplestory",
      "display_name": "ë©”ì´í”ŒìŠ¤í† ë¦¬",
      "icon_url": "https://...",
      "categories": ["ê³µì§€ì‚¬í•­", "ì—…ë°ì´íŠ¸", "ì´ë²¤íŠ¸"]
    }
  ]
}
```

---

## ğŸ“¦ 4. ì•Œë¦¼ API (êµ¬ë… ê´€ë ¨)

í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë‹¤ìŒ APIë“¤ì„ í˜¸ì¶œí•˜ê³  ìˆìœ¼ë¯€ë¡œ êµ¬í˜„ í•„ìš”:

### ğŸ“Œ GET `/api/notifications/`
ì‚¬ìš©ìê°€ êµ¬ë…í•œ ê²Œì„ì˜ ì•Œë¦¼ í”¼ë“œ ì¡°íšŒ

**ìš”ì²­ í—¤ë”**
```
Authorization: Bearer {accessToken}
```

**ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°**
- `limit` (optional): ì¡°íšŒí•  ì•Œë¦¼ ê°œìˆ˜

**ì‘ë‹µ í˜•ì‹**
```json
[
  {
    "game_id": "maplestory",
    "game": "ë©”ì´í”ŒìŠ¤í† ë¦¬",
    "category": "ì—…ë°ì´íŠ¸",
    "title": "ì‹ ê·œ ì—…ë°ì´íŠ¸ ê³µì§€",
    "url": "https://maplestory.nexon.com/...",
    "date": "2025-11-17T10:00:00Z"
  }
]
```

### ğŸ“Œ GET `/api/subscriptions/`
ë‚´ êµ¬ë… ëª©ë¡ ì¡°íšŒ

**ì‘ë‹µ í˜•ì‹**
```json
{
  "results": [
    {
      "id": 1,
      "game_id": "maplestory",
      "category": "ì—…ë°ì´íŠ¸",
      "created_at": "2025-11-17T10:00:00Z"
    }
  ]
}
```

### ğŸ“Œ POST `/api/subscriptions/`
êµ¬ë… ì¶”ê°€

**ìš”ì²­ (Request)**
```json
{
  "game_id": "maplestory",
  "category": "ì—…ë°ì´íŠ¸"
}
```

### ğŸ“Œ DELETE `/api/subscriptions/{id}/`
êµ¬ë… ì·¨ì†Œ

---

## ğŸ—„ï¸ 5. ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸ ì˜ˆì‹œ

```python
# models.py
from django.db import models

class User(models.Model):
    toss_user_key = models.BigIntegerField(unique=True)
    access_token = models.TextField(null=True, blank=True)
    refresh_token = models.TextField(null=True, blank=True)
    scope = models.TextField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'users'

class Subscription(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    game_id = models.CharField(max_length=100)
    category = models.CharField(max_length=100)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        db_table = 'subscriptions'
        unique_together = ('user', 'game_id', 'category')
```

---

## ğŸ”— 6. URL ë¼ìš°íŒ… ì˜ˆì‹œ

```python
# urls.py
from django.urls import path
from . import views

urlpatterns = [
    # ì¸ì¦
    path('api/auth/login', views.toss_login, name='toss_login'),
    path('api/auth/me', views.get_user_info, name='get_user_info'),
    path('api/auth/refresh', views.refresh_token, name='refresh_token'),
    path('api/auth/logout', views.logout, name='logout'),

    # ê²Œì„ (ì´ë¯¸ ìˆì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒ)
    path('api/games/', views.game_list, name='game_list'),

    # ì•Œë¦¼
    path('api/notifications/', views.notification_feed, name='notification_feed'),

    # êµ¬ë…
    path('api/subscriptions/', views.subscription_list, name='subscription_list'),
    path('api/subscriptions/<int:pk>/', views.subscription_delete, name='subscription_delete'),
]
```

---

## ğŸ“š 7. ì°¸ê³  ë¬¸ì„œ

### í† ìŠ¤ ë¡œê·¸ì¸ ê°œë°œ ê°€ì´ë“œ
- ê³µì‹ ë¬¸ì„œ: https://developers-apps-in-toss.toss.im/login/develop.md
- BaseURL: `https://apps-in-toss-api.toss.im`

### mTLS ì¸ì¦ì„œ ê°€ì´ë“œ
- ê³µì‹ ë¬¸ì„œ: https://developers-apps-in-toss.toss.im/development/integration-process.md

### ì£¼ìš” API ì—”ë“œí¬ì¸íŠ¸ (í† ìŠ¤ ì„œë²„)
1. AccessToken ë°œê¸‰: `POST /api-partner/v1/apps-in-toss/user/oauth2/generate-token`
2. AccessToken ì¬ë°œê¸‰: `POST /api-partner/v1/apps-in-toss/user/oauth2/refresh-token`
3. ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ: `GET /api-partner/v1/apps-in-toss/user/oauth2/login-me`
4. ë¡œê·¸ì¸ ì—°ê²° ëŠê¸°: `POST /api-partner/v1/apps-in-toss/user/oauth2/access/remove-by-access-token`

---

## âš ï¸ 8. ì£¼ì˜ì‚¬í•­

### ë³´ì•ˆ
1. mTLS ì¸ì¦ì„œ íŒŒì¼(`client-cert.pem`, `client-key.pem`)ì€ **ì ˆëŒ€ Gitì— ì»¤ë°‹í•˜ì§€ ë§ˆì„¸ìš”**
2. `.gitignore`ì— ì¸ì¦ì„œ ê²½ë¡œ ì¶”ê°€
3. ì¸ì¦ì„œëŠ” í™˜ê²½ ë³€ìˆ˜ë‚˜ ì•ˆì „í•œ ì €ì¥ì†Œì— ë³´ê´€

### í† í° ìœ íš¨ì‹œê°„
- AccessToken: 1ì‹œê°„
- RefreshToken: 14ì¼
- AuthorizationCode: 10ë¶„

### CORS
- í”„ë¡œë•ì…˜ ë°°í¬ ì‹œ `CORS_ALLOW_ALL_ORIGINS = True` ì œê±°
- ì •í™•í•œ ë„ë©”ì¸ë§Œ í—ˆìš© ëª©ë¡ì— ì¶”ê°€

### ì—ëŸ¬ ì²˜ë¦¬
- í† ìŠ¤ API ì‘ë‹µì˜ `resultType`ì„ í•­ìƒ í™•ì¸
- `resultType: "FAIL"`ì¸ ê²½ìš° `error.errorCode`ì™€ `error.reason` í™•ì¸
- ì ì ˆí•œ HTTP ìƒíƒœ ì½”ë“œ ë°˜í™˜ (401, 400, 500 ë“±)

---

## ğŸ§ª 9. í…ŒìŠ¤íŠ¸ ë°©ë²•

### ë¡œì»¬ í…ŒìŠ¤íŠ¸
1. Django ì„œë²„ ì‹¤í–‰: `python manage.py runserver`
2. Postmanì´ë‚˜ curlë¡œ API í…ŒìŠ¤íŠ¸
3. í”„ë¡ íŠ¸ì—”ë“œ `.env` íŒŒì¼ì—ì„œ `VITE_API_BASE_URL`ì„ ë¡œì»¬ ì£¼ì†Œë¡œ ë³€ê²½

### ì•±ì¸í† ìŠ¤ ìƒŒë“œë°•ìŠ¤ í…ŒìŠ¤íŠ¸
1. Django ì„œë²„ë¥¼ ê³µê°œ URLë¡œ ë°°í¬ (ì˜ˆ: AWS, Heroku ë“±)
2. CORSì— ìƒŒë“œë°•ìŠ¤ ë„ë©”ì¸ ì¶”ê°€
3. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì‹¤ì œ `appLogin()` í˜¸ì¶œí•˜ì—¬ í…ŒìŠ¤íŠ¸

---

## ğŸ“ 10. ë¬¸ì˜ì‚¬í•­

ì´ ë¬¸ì„œì— ëŒ€í•œ ì§ˆë¬¸ì´ë‚˜ ì¶”ê°€ ìš”ì²­ì‚¬í•­ì´ ìˆìœ¼ë©´ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œìì—ê²Œ ì—°ë½ ì£¼ì„¸ìš”.

### ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] CORS ì„¤ì • ì™„ë£Œ
- [ ] mTLS ì¸ì¦ì„œ ë°œê¸‰ ë° ì„¤ì •
- [ ] POST `/api/auth/login` êµ¬í˜„
- [ ] GET `/api/auth/me` êµ¬í˜„
- [ ] POST `/api/auth/refresh` êµ¬í˜„
- [ ] POST `/api/auth/logout` êµ¬í˜„
- [ ] GET `/api/notifications/` êµ¬í˜„
- [ ] GET `/api/subscriptions/` êµ¬í˜„
- [ ] POST `/api/subscriptions/` êµ¬í˜„
- [ ] DELETE `/api/subscriptions/{id}/` êµ¬í˜„
- [ ] ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì™„ë£Œ
- [ ] ìƒŒë“œë°•ìŠ¤ í™˜ê²½ í…ŒìŠ¤íŠ¸ ì™„ë£Œ
