{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
    /* 전체 레이아웃 */
    .result-type-container {
        margin-bottom: 2rem;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        background-color: #fff;
        overflow: hidden;
    }
    
    .result-type-header {
        background-color: #f8f9fa;
        padding: 1rem;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .result-type-body {
        padding: 1rem;
    }
    
    /* 탭 스타일 */
    .tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 1rem;
    }
    
    .tab {
        padding: 0.5rem 1rem;
        cursor: pointer;
        border: 1px solid transparent;
        border-bottom: none;
        margin-right: 5px;
    }
    
    .tab.active {
        background-color: #fff;
        border-color: #ddd;
        border-bottom: 1px solid #fff;
        margin-bottom: -1px;
        border-radius: 3px 3px 0 0;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* 이미지 그리드 */
    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .image-item {
        border: 1px solid #eee;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
        transition: all 0.2s ease;
    }
    
    .image-item:hover {
        box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    
    .image-item.main-image {
        border: 3px solid #28a745;
    }
    
    .image-preview {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }
    
    .image-info {
        padding: 0.5rem;
    }
    
    .image-title {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .image-actions {
        display: flex;
        justify-content: space-between;
    }
    
    /* 특성 및 예시 관리 */
    .data-list {
        list-style: none;
        padding-left: 0;
        margin-bottom: 1rem;
    }
    
    .data-item {
        padding: 0.5rem;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 3px;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .add-btn {
        margin-bottom: 1rem;
    }
    
    /* 업로드 영역 */
    .upload-area {
        border: 2px dashed #ddd;
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .upload-area:hover {
        border-color: #28a745;
        background-color: #f8f9fa;
    }
    
    .upload-area input[type="file"] {
        display: none;
    }
    
    /* 모달 스타일 */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: #fff;
        margin: 5% auto;
        padding: 20px;
        border-radius: 5px;
        width: 80%;
        max-width: 600px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        position: relative;
    }
    
    .close-modal {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
    }
    
    /* 폼 스타일 */
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
    }
    
    .btn {
        display: inline-block;
        padding: 0.375rem 0.75rem;
        font-size: 0.9rem;
        font-weight: 400;
        line-height: 1.5;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        user-select: none;
        border: 1px solid transparent;
        border-radius: 0.25rem;
        transition: all 0.15s ease-in-out;
        cursor: pointer;
    }
    
    .btn-primary {
        color: #fff;
        background-color: #007bff;
        border-color: #007bff;
    }
    
    .btn-success {
        color: #fff;
        background-color: #28a745;
        border-color: #28a745;
    }
    
    .btn-danger {
        color: #fff;
        background-color: #dc3545;
        border-color: #dc3545;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
    
    /* 알림 메시지 */
    .message-container {
        padding: 0.75rem 1.25rem;
        margin-bottom: 1rem;
        border-radius: 0.25rem;
        display: none;
    }
    
    .message-success {
        color: #155724;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
    }
    
    .message-error {
        color: #721c24;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>{{ test.name }} - 통합 결과 유형 관리</h1>
    
    <div id="message-container" class="message-container"></div>
    
    {% for result_type in result_types %}
    <div class="result-type-container" id="result-type-{{ result_type.id }}">
        <div class="result-type-header">
            <h2>{{ result_type.name }} (ID: {{ result_type.type_id }})</h2>
            <div>
                <button class="btn btn-primary btn-sm edit-result-btn" data-id="{{ result_type.id }}">정보 수정</button>
            </div>
        </div>
        
        <div class="result-type-body">
            <div class="tabs">
                <div class="tab active" data-tab="images-{{ result_type.id }}">이미지</div>
                <div class="tab" data-tab="characteristics-{{ result_type.id }}">특성</div>
                <div class="tab" data-tab="examples-{{ result_type.id }}">예시</div>
            </div>
            
            <!-- 이미지 관리 탭 -->
            <div class="tab-content active" id="images-{{ result_type.id }}">
                <div class="upload-area" id="upload-area-{{ result_type.id }}">
                    <input type="file" id="file-upload-{{ result_type.id }}" class="file-upload" data-type-id="{{ result_type.id }}" accept="image/*" multiple>
                    <div>
                        <i class="fa fa-cloud-upload"></i>
                        <p>이미지를 드래그하거나 클릭하여 업로드하세요</p>
                    </div>
                </div>
                
                <div class="image-grid" id="image-grid-{{ result_type.id }}">
                    {% for image in result_type.images.all %}
                    <div class="image-item {% if image.is_main %}main-image{% endif %}" data-image-id="{{ image.id }}">
                        <img src="{{ image.image.url }}" alt="{{ image.title }}" class="image-preview">
                        <div class="image-info">
                            <div class="image-title">{{ image.title|default:"제목 없음" }}</div>
                            <div class="image-actions">
                                <button class="btn btn-success btn-sm set-main-btn" data-image-id="{{ image.id }}" {% if image.is_main %}disabled{% endif %}>대표</button>
                                <button class="btn btn-danger btn-sm delete-image-btn" data-image-id="{{ image.id }}">삭제</button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="no-images-msg">등록된 이미지가 없습니다.</p>
                    {% endfor %}
                </div>
            </div>
            
            <!-- 특성 관리 탭 -->
            <div class="tab-content" id="characteristics-{{ result_type.id }}">
                <button class="btn btn-primary add-btn add-characteristic-btn" data-id="{{ result_type.id }}">특성 추가</button>
                <ul class="data-list" id="characteristics-list-{{ result_type.id }}">
                    {% with characteristics=result_type.get_characteristics_list %}
                    {% for characteristic in characteristics %}
                    <li class="data-item">
                        <span>{{ characteristic }}</span>
                        <button class="btn btn-danger btn-sm delete-characteristic-btn" data-id="{{ result_type.id }}" data-index="{{ forloop.counter0 }}">삭제</button>
                    </li>
                    {% empty %}
                    <li class="no-data-msg">등록된 특성이 없습니다.</li>
                    {% endfor %}
                    {% endwith %}
                </ul>
            </div>
            
            <!-- 예시 관리 탭 -->
            <div class="tab-content" id="examples-{{ result_type.id }}">
                <button class="btn btn-primary add-btn add-example-btn" data-id="{{ result_type.id }}">예시 추가</button>
                <ul class="data-list" id="examples-list-{{ result_type.id }}">
                    {% with examples=result_type.get_examples_list %}
                    {% for example in examples %}
                    <li class="data-item">
                        <span>{{ example }}</span>
                        <button class="btn btn-danger btn-sm delete-example-btn" data-id="{{ result_type.id }}" data-index="{{ forloop.counter0 }}">삭제</button>
                    </li>
                    {% empty %}
                    <li class="no-data-msg">등록된 예시가 없습니다.</li>
                    {% endfor %}
                    {% endwith %}
                </ul>
            </div>
        </div>
    </div>
    {% empty %}
    <p>등록된 결과 유형이 없습니다.</p>
    {% endfor %}
</div>

<!-- 결과 유형 편집 모달 -->
<div id="edit-result-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>결과 유형 정보 수정</h2>
        <form id="edit-result-form">
            <input type="hidden" id="edit-result-id">
            <div class="form-group">
                <label for="edit-result-name">이름</label>
                <input type="text" id="edit-result-name" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit-result-description">설명</label>
                <textarea id="edit-result-description" class="form-control" rows="5" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">저장</button>
        </form>
    </div>
</div>

<!-- 특성 추가 모달 -->
<div id="add-characteristic-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>특성 추가</h2>
        <form id="add-characteristic-form">
            <input type="hidden" id="add-characteristic-type-id">
            <div class="form-group">
                <label for="characteristic-text">특성 내용</label>
                <input type="text" id="characteristic-text" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">추가</button>
        </form>
    </div>
</div>

<!-- 예시 추가 모달 -->
<div id="add-example-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>예시 추가</h2>
        <form id="add-example-form">
            <input type="hidden" id="add-example-type-id">
            <div class="form-group">
                <label for="example-text">예시 내용</label>
                <input type="text" id="example-text" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">추가</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 탭 전환 기능
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            const tabsContainer = this.closest('.tabs');
            const tabContentContainer = tabsContainer.parentElement;
            
            // 탭 활성화
            tabsContainer.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // 탭 컨텐츠 활성화
            tabContentContainer.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        });
    });
    
    // 이미지 업로드 영역 클릭 시 파일 선택 창 열기
    document.querySelectorAll('.upload-area').forEach(area => {
        area.addEventListener('click', function() {
            const typeId = this.id.replace('upload-area-', '');
            document.getElementById('file-upload-' + typeId).click();
        });
    });
    
    // 파일 드래그 & 드롭 이벤트
    document.querySelectorAll('.upload-area').forEach(area => {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            area.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            area.addEventListener(eventName, () => {
                area.classList.add('highlight');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            area.addEventListener(eventName, () => {
                area.classList.remove('highlight');
            }, false);
        });
        
        area.addEventListener('drop', function(e) {
            const typeId = this.id.replace('upload-area-', '');
            const fileInput = document.getElementById('file-upload-' + typeId);
            fileInput.files = e.dataTransfer.files;
            handleFiles(fileInput);
        }, false);
    });
    
    // 파일 선택 시 업로드 처리
    document.querySelectorAll('.file-upload').forEach(input => {
        input.addEventListener('change', function() {
            handleFiles(this);
        });
    });
    
    // 파일 업로드 처리 함수
    function handleFiles(input) {
        const files = input.files;
        const typeId = input.getAttribute('data-type-id');
        
        if (!files.length) return;
        
        [...files].forEach(file => {
            uploadFile(file, typeId);
        });
    }
    
    // 파일 업로드 함수
    function uploadFile(file, typeId) {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('title', file.name);
        
        fetch(`/facetest/admin/result-type/${typeId}/upload-image/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('이미지가 성공적으로 업로드되었습니다.', 'success');
                
                // 이미지 그리드에 새 이미지 추가
                const imageGrid = document.getElementById('image-grid-' + typeId);
                const noImagesMsg = imageGrid.querySelector('.no-images-msg');
                if (noImagesMsg) {
                    noImagesMsg.remove();
                }
                
                const newImageItem = document.createElement('div');
                newImageItem.className = 'image-item';
                newImageItem.setAttribute('data-image-id', data.image_id);
                newImageItem.innerHTML = `
                    <img src="${data.image_url}" alt="${file.name}" class="image-preview">
                    <div class="image-info">
                        <div class="image-title">${file.name}</div>
                        <div class="image-actions">
                            <button class="btn btn-success btn-sm set-main-btn" data-image-id="${data.image_id}">대표</button>
                            <button class="btn btn-danger btn-sm delete-image-btn" data-image-id="${data.image_id}">삭제</button>
                        </div>
                    </div>
                `;
                imageGrid.appendChild(newImageItem);
                
                // 이벤트 핸들러 다시 연결
                attachImageEventHandlers();
            } else {
                showMessage('업로드 실패: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showMessage('업로드 실패: ' + error, 'error');
        });
    }
    
    // 메시지 표시 함수
    function showMessage(text, type) {
        const container = document.getElementById('message-container');
        container.textContent = text;
        container.className = 'message-container message-' + type;
        container.style.display = 'block';
        
        // 3초 후 메시지 숨기기
        setTimeout(() => {
            container.style.display = 'none';
        }, 3000);
    }
    
    // 이미지 이벤트 핸들러 연결 함수
    function attachImageEventHandlers() {
        // 대표 이미지 설정 버튼
        document.querySelectorAll('.set-main-btn').forEach(btn => {
            btn.onclick = function() {
                const imageId = this.getAttribute('data-image-id');
                
                fetch(`/facetest/admin/result-image/${imageId}/set-main/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage('대표 이미지가 설정되었습니다.', 'success');
                        
                        // 모든 이미지 대표 상태 제거
                        const imageItem = this.closest('.image-item');
                        const resultTypeContainer = imageItem.closest('.tab-content');
                        resultTypeContainer.querySelectorAll('.image-item').forEach(item => {
                            item.classList.remove('main-image');
                            item.querySelector('.set-main-btn').disabled = false;
                        });
                        
                        // 현재 이미지 대표로 설정
                        imageItem.classList.add('main-image');
                        this.disabled = true;
                    } else {
                        showMessage('오류가 발생했습니다: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    showMessage('요청 처리 중 오류가 발생했습니다: ' + error, 'error');
                });
            };
        });
        
        // 이미지 삭제 버튼
        document.querySelectorAll('.delete-image-btn').forEach(btn => {
            btn.onclick = function() {
                if (confirm('정말로 이 이미지를 삭제하시겠습니까?')) {
                    const imageId = this.getAttribute('data-image-id');
                    const imageItem = this.closest('.image-item');
                    
                    fetch(`/facetest/admin/result-image/${imageId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showMessage('이미지가 삭제되었습니다.', 'success');
                            imageItem.remove();
                            
                            // 이미지가 없는지 확인
                            const imageGrid = imageItem.closest('.image-grid');
                            if (!imageGrid.querySelector('.image-item')) {
                                const noImagesMsg = document.createElement('p');
                                noImagesMsg.className = 'no-images-msg';
                                noImagesMsg.textContent = '등록된 이미지가 없습니다.';
                                imageGrid.appendChild(noImagesMsg);
                            }
                        } else {
                            showMessage('오류가 발생했습니다: ' + data.error, 'error');
                        }
                    })
                    .catch(error => {
                        showMessage('요청 처리 중 오류가 발생했습니다: ' + error, 'error');
                    });
                }
            };
        });
    }
    
    // 결과 유형 정보 수정
    document.querySelectorAll('.edit-result-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const typeId = this.getAttribute('data-id');
            const resultTypeElement = document.getElementById('result-type-' + typeId);
            const titleElement = resultTypeElement.querySelector('h2');
            const descriptionElement = resultTypeElement.querySelector('.result-type-body');
            
            const modal = document.getElementById('edit-result-modal');
            const nameInput = document.getElementById('edit-result-name');
            const descriptionInput = document.getElementById('edit-result-description');
            const typeIdInput = document.getElementById('edit-result-id');
            
            // 모달에 현재 값 설정
            typeIdInput.value = typeId;
            nameInput.value = titleElement.textContent.split(' (ID')[0].trim();
            
            // 설명 가져오기 (실제로는 API 호출이 필요할 수 있음)
            fetch(`/facetest/admin/result-type/${typeId}/get-info/`, {
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    descriptionInput.value = data.description;
                    modal.style.display = 'block';
                } else {
                    showMessage('정보를 불러오는데 실패했습니다: ' + data.error, 'error');
                }
            })
            .catch(error => {
                // 에러 발생 시 임시 대체
                console.error('결과 유형 정보를 가져오는데 실패했습니다:', error);
                descriptionInput.value = '결과 유형에 대한 설명 불러오기 실패';
                modal.style.display = 'block';
            });
        });
    });
    
    // 결과 유형 수정 폼 제출
    document.getElementById('edit-result-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const typeId = document.getElementById('edit-result-id').value;
        const name = document.getElementById('edit-result-name').value;
        const description = document.getElementById('edit-result-description').value;
        
        fetch(`/facetest/admin/result-type/${typeId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                name: name,
                description: description
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('결과 유형 정보가 업데이트되었습니다.', 'success');
                
                // 화면 업데이트
                const resultTypeElement = document.getElementById('result-type-' + typeId);
                const titleElement = resultTypeElement.querySelector('h2');
                
                // ID 부분 유지하면서 이름 변경
                const idPart = titleElement.textContent.match(/\(ID: \d+\)/)[0];
                titleElement.textContent = `${name} ${idPart}`;
                
                // 모달 닫기
                document.getElementById('edit-result-modal').style.display = 'none';
            } else {
                showMessage('업데이트 실패: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showMessage('업데이트 실패: ' + error, 'error');
        });
    });
    
    // 특성 추가 버튼
    document.querySelectorAll('.add-characteristic-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const typeId = this.getAttribute('data-id');
            document.getElementById('add-characteristic-type-id').value = typeId;
            document.getElementById('add-characteristic-modal').style.display = 'block';
        });
    });
    
    // 특성 추가 폼 제출
    document.getElementById('add-characteristic-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const typeId = document.getElementById('add-characteristic-type-id').value;
        const text = document.getElementById('characteristic-text').value;
        
        // 현재 특성 목록 가져오기
        let characteristics = [];
        document.querySelectorAll(`#characteristics-list-${typeId} .data-item span`).forEach(span => {
            characteristics.push(span.textContent);
        });
        
        // 새 특성 추가
        characteristics.push(text);
        
        updateCharacteristics(typeId, characteristics);
    });
    
    // 특성 삭제 버튼
    document.querySelectorAll('.delete-characteristic-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const typeId = this.getAttribute('data-id');
            const index = parseInt(this.getAttribute('data-index'));
            
            // 현재 특성 목록 가져오기
            let characteristics = [];
            document.querySelectorAll(`#characteristics-list-${typeId} .data-item span`).forEach(span => {
                characteristics.push(span.textContent);
            });
            
            // 해당 인덱스 삭제
            characteristics.splice(index, 1);
            
            updateCharacteristics(typeId, characteristics);
        });
    });
    
    // 특성 업데이트 함수
    function updateCharacteristics(typeId, characteristics) {
        fetch(`/facetest/admin/result-type/${typeId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                characteristics: characteristics
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('특성이 업데이트되었습니다.', 'success');
                
                // 특성 목록 UI 업데이트
                const list = document.getElementById(`characteristics-list-${typeId}`);
                list.innerHTML = '';
                
                if (characteristics.length > 0) {
                    characteristics.forEach((characteristic, index) => {
                        const li = document.createElement('li');
                        li.className = 'data-item';
                        li.innerHTML = `
                            <span>${characteristic}</span>
                            <button class="btn btn-danger btn-sm delete-characteristic-btn" data-id="${typeId}" data-index="${index}">삭제</button>
                        `;
                        list.appendChild(li);
                    });
                    
                    // 이벤트 핸들러 다시 연결
                    attachCharacteristicEventHandlers();
                } else {
                    const li = document.createElement('li');
                    li.className = 'no-data-msg';
                    li.textContent = '등록된 특성이 없습니다.';
                    list.appendChild(li);
                }
                
                // 모달 닫기
                document.getElementById('add-characteristic-modal').style.display = 'none';
                document.getElementById('characteristic-text').value = '';
            } else {
                showMessage('업데이트 실패: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showMessage('업데이트 실패: ' + error, 'error');
        });
    }
    
    // 특성 이벤트 핸들러 연결 함수
    function attachCharacteristicEventHandlers() {
        document.querySelectorAll('.delete-characteristic-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const typeId = this.getAttribute('data-id');
                const index = parseInt(this.getAttribute('data-index'));
                
                // 현재 특성 목록 가져오기
                let characteristics = [];
                document.querySelectorAll(`#characteristics-list-${typeId} .data-item span`).forEach(span => {
                    characteristics.push(span.textContent);
                });
                
                // 해당 인덱스 삭제
                characteristics.splice(index, 1);
                
                updateCharacteristics(typeId, characteristics);
            });
        });
    }
    
    // 예시 관련 코드는 특성과 유사하게 구현
    
    // 예시 추가 버튼
    document.querySelectorAll('.add-example-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const typeId = this.getAttribute('data-id');
            document.getElementById('add-example-type-id').value = typeId;
            document.getElementById('add-example-modal').style.display = 'block';
        });
    });
    
    // 예시 추가 폼 제출
    document.getElementById('add-example-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const typeId = document.getElementById('add-example-type-id').value;
        const text = document.getElementById('example-text').value;
        
        // 현재 예시 목록 가져오기
        let examples = [];
        document.querySelectorAll(`#examples-list-${typeId} .data-item span`).forEach(span => {
            examples.push(span.textContent);
        });
        
        // 새 예시 추가
        examples.push(text);
        
        updateExamples(typeId, examples);
    });
    
    // 예시 삭제 버튼
    document.querySelectorAll('.delete-example-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const typeId = this.getAttribute('data-id');
            const index = parseInt(this.getAttribute('data-index'));
            
            // 현재 예시 목록 가져오기
            let examples = [];
            document.querySelectorAll(`#examples-list-${typeId} .data-item span`).forEach(span => {
                examples.push(span.textContent);
            });
            
            // 해당 인덱스 삭제
            examples.splice(index, 1);
            
            updateExamples(typeId, examples);
        });
    });
    
    // 예시 업데이트 함수
    function updateExamples(typeId, examples) {
        fetch(`/facetest/admin/result-type/${typeId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                examples: examples
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('예시가 업데이트되었습니다.', 'success');
                
                // 예시 목록 UI 업데이트
                const list = document.getElementById(`examples-list-${typeId}`);
                list.innerHTML = '';
                
                if (examples.length > 0) {
                    examples.forEach((example, index) => {
                        const li = document.createElement('li');
                        li.className = 'data-item';
                        li.innerHTML = `
                            <span>${example}</span>
                            <button class="btn btn-danger btn-sm delete-example-btn" data-id="${typeId}" data-index="${index}">삭제</button>
                        `;
                        list.appendChild(li);
                    });
                    
                    // 이벤트 핸들러 다시 연결
                    attachExampleEventHandlers();
                } else {
                    const li = document.createElement('li');
                    li.className = 'no-data-msg';
                    li.textContent = '등록된 예시가 없습니다.';
                    list.appendChild(li);
                }
                
                // 모달 닫기
                document.getElementById('add-example-modal').style.display = 'none';
                document.getElementById('example-text').value = '';
            } else {
                showMessage('업데이트 실패: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showMessage('업데이트 실패: ' + error, 'error');
        });
    }
    
    // 예시 이벤트 핸들러 연결 함수
    function attachExampleEventHandlers() {
        document.querySelectorAll('.delete-example-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const typeId = this.getAttribute('data-id');
                const index = parseInt(this.getAttribute('data-index'));
                
                // 현재 예시 목록 가져오기
                let examples = [];
                document.querySelectorAll(`#examples-list-${typeId} .data-item span`).forEach(span => {
                    examples.push(span.textContent);
                });
                
                // 해당 인덱스 삭제
                examples.splice(index, 1);
                
                updateExamples(typeId, examples);
            });
        });
    }
    
    // 모달 닫기 버튼
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
        });
    });
    
    // 모달 바깥 클릭 시 닫기
    window.addEventListener('click', function(event) {
        document.querySelectorAll('.modal').forEach(modal => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
    
    // 초기 이벤트 핸들러 연결
    attachImageEventHandlers();
    attachCharacteristicEventHandlers();
    attachExampleEventHandlers();
});
</script>
{% endblock %}