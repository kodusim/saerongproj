{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
    body {
        background-color: {{ result_type.background_color|default:"#FFF5EE" }};
    }

    /* 모든 결과 보기 버튼 스타일 */
    .all-results-btn {
        display: inline-block;
        padding: 8px 20px;
        border: 1px solid #333;
        background-color: white;
        color: #333;
        font-size: 16px;
        font-weight: normal;
        cursor: pointer;
    }

    .all-results-btn:hover {
        background-color: #f8f8f8;
    }

    /* 모달 스타일 */
    .results-modal {
        display: none;
        position: fixed;
        z-index: 1050;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.7);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 0;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background-color: #fefefe;
        border-bottom: 1px solid #eee;
        position: sticky;
        top: 0;
        z-index: 5;
    }

    .modal-body {
        padding: 15px;
        overflow-y: auto;
        flex-grow: 1;
    }

    .close-modal {
        width: 24px;
        height: 24px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 50%;
        background-color: #f2f2f2;
        color: #333;
        line-height: 1;
        margin-left: 10px;
    }

    .result-item {
        margin-bottom: 20px;
        border-radius: 10px;
        overflow: hidden;
    }
    /* 공통 설정 */
    .result-image-container, .sub-image-container {
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
        text-align: center;
    }
    .result-image, .sub-image {
        width: 100%;
        height: auto;
        object-fit: contain;
        display: block;
    }
    .image-save-hint {
        text-align: center;
        font-size: 16px;
        color: #000;
        font-weight: bold;
        padding: 10px 0;
        margin-bottom: 10px;
    }

    /* 결과 카드 */
    .result-cards {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 30px;
    }
    .result-card {
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    .card-header {
        padding: 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
    }
    .card-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin: 0;
    }
    .card-body {
        padding: 20px;
    }
    .characteristics-list, .examples-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .characteristic-item {
        padding: 10px 15px;
        margin-bottom: 8px;
        background: #f8f9fa;
        border-left: 3px solid #007bff;
        border-radius: 4px;
    }
    .example-item {
        background: #e9f5ff;
        color: #0056b3;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
    }

    /* 공유 버튼 */
    .share-container {
        margin-top: 30px;
        text-align: center;
    }
    .share-title {
        font-size: 1rem;
        margin-bottom: 15px;
    }
    .share-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
    }
    .share-button {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: none;
    }
    .share-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
    }

    /* 푸터 */
    .custom-footer {
        position: fixed;
        bottom: 0;
        width: 500px;
        max-width: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(to right, #ffe6f2, #ffcce6, #ffb3d9);
        padding: 15px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
        border-top: 1px solid rgba(255, 204, 230, 0.7);
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }
    .kakao-share-btn {
        background: #FEE500;
        color: #000;
        flex-grow: 2;
        border-radius: 25px;
        padding: 12px 20px;
        margin: 0 15px 0 10px;
        text-align: center;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: all 0.2s;
        border: none;
    }
    .kakao-share-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .back-btn {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: white;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 15px;
        text-decoration: none;
        color: #333;
        font-size: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: all 0.2s;
        border: none;
    }
    .back-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .bottom-padding {
        padding-bottom: 80px;
    }
</style>

<div class="container p-0">
    <div class="result-content">
        {% if result_type %}
            {% with main_image=result_type.images.filter.first %}
                {% if main_image %}
                <div class="result-image-container">
                    <img src="{{ main_image.image.url }}" alt="{{ result_type.name }}" class="result-image w-100">
                </div>
                <div class="image-save-hint">⬆️ 꼬옥 눌러 이미지 저장하기</div>
                {% endif %}
            {% endwith %}

            {% if characteristics %}
            <div class="result-cards">
                <div class="result-card">
                    <div class="card-header">
                        <h2 class="card-title">특징</h2>
                    </div>
                    <div class="card-body">
                        <ul class="characteristics-list">
                            {% for characteristic in characteristics %}
                                <li class="characteristic-item">{{ characteristic }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                {% if examples %}
                <div class="result-card">
                    <div class="card-header">
                        <h2 class="card-title">유사한 유명인</h2>
                    </div>
                    <div class="card-body">
                        <div class="examples-list">
                            {% for example in examples %}
                                <div class="example-item">{{ example }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <div class="text-center">
                <button id="showAllResults" class="all-results-btn">모든 결과 보기</button>
            </div>

            <div class="share-container">
                <div class="share-title">결과 공유하기</div>
                <div class="share-buttons">
                    <button id="link-copy-btn" class="share-button">
                        <img src="{% static 'images/share_icon.png' %}" alt="공유" class="share-icon">
                    </button>
                    <button id="facebook-share-btn" class="share-button">
                        <img src="{% static 'images/facebook_icon.png' %}" alt="Facebook" class="share-icon">
                    </button>
                    <button id="twitter-share-btn" class="share-button">
                        <img src="{% static 'images/twitter_x_icon.png' %}" alt="X" class="share-icon">
                    </button>
                    <button id="kakao-share-btn" class="share-button">
                        <img src="{% static 'images/kakao_icon.png' %}" alt="KakaoTalk" class="share-icon">
                    </button>
                </div>
            </div>
            <div class="bottom-padding"></div>

        {% else %}
            <div class="alert alert-info">
                결과를 불러올 수 없습니다. 다시 시도해주세요.
            </div>
        {% endif %}
    </div>
</div>

<div class="custom-footer">
    <a href="#" class="kakao-share-btn" id="kakao-footer-btn">카카오톡으로 공유하기</a>
    <a href="{% url 'facetest:index' %}" class="back-btn">
        <i class="back-icon">↩</i>
    </a>
</div>

<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js" integrity="sha384-TiCUE00h649CAMonG018J2ujOgDKW/kVWlChEuu4jK2vxfAAD0eZxzCKakxg55G4" crossorigin="anonymous"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const shareUrl = window.location.href.split('#')[0];
    const testUrl = '{{ request.scheme }}://{{ request.get_host }}{% url "facetest:index" %}';
    const title = "내 얼굴상 테스트 결과: {% if result_type %}{{ result_type.name }}{% else %}얼굴상 분석{% endif %}";
    const description = "{% if result_type %}{{ result_type.description|truncatechars:50|escapejs }}{% else %}얼굴상 분석 결과{% endif %}";

    document.getElementById('link-copy-btn').addEventListener('click', function() {
        navigator.clipboard.writeText(shareUrl)
            .then(() => alert('링크가 복사되었습니다.'))
            .catch(fallbackCopy);

        function fallbackCopy() {
            const textarea = document.createElement('textarea');
            textarea.value = shareUrl;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('링크가 복사되었습니다.');
            } catch {
                alert('링크 복사에 실패했습니다.');
            }
            document.body.removeChild(textarea);
        }
    });

    document.getElementById('facebook-share-btn').addEventListener('click', function() {
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`, '_blank');
    });

    document.getElementById('twitter-share-btn').addEventListener('click', function() {
        window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(title)}`, '_blank');
    });

    function setupKakaoShare(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: title,
                    description: description,
                    imageUrl: {% with main_image=result_type.images.filter.first %}{% if main_image %}'{{ request.scheme }}://{{ request.get_host }}{{ main_image.image.url }}'{% else %}''{% endif %}{% endwith %},
                    link: { mobileWebUrl: shareUrl, webUrl: shareUrl }
                },
                buttons: [
                    { title: '결과 확인하기', link: { mobileWebUrl: shareUrl, webUrl: shareUrl }},
                    { title: '테스트 하기', link: { mobileWebUrl: testUrl, webUrl: testUrl }}
                ]
            });
        });
    }

    try {
        Kakao.init('{{ kakao_api_key }}');
        setupKakaoShare(document.getElementById('kakao-share-btn'));
        setupKakaoShare(document.getElementById('kakao-footer-btn'));
    } catch (e) {
        alert('카카오톡 공유 기능을 초기화하는데 실패했습니다.');
    }

    const modal = document.getElementById('resultsModal');
    const openModalBtn = document.getElementById('showAllResults');
    const closeModalBtn = document.querySelector('.close-modal');

    if (openModalBtn) openModalBtn.onclick = () => modal.style.display = 'block';
    if (closeModalBtn) closeModalBtn.onclick = () => modal.style.display = 'none';
    window.onclick = e => { if (e.target == modal) modal.style.display = 'none'; };
});
</script>

<div id="resultsModal" class="results-modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">모든 결과 보기</div>
            <div class="close-modal">✕</div>
        </div>
        <div class="modal-body">
            <div class="results-container">
                {% for other_result in all_results %}
                    <div class="result-item">
                        {% with main_image=other_result.images.filter.first %}
                            {% if main_image %}
                                <img src="{{ main_image.image.url }}" alt="{{ other_result.name }}" class="result-image">
                            {% endif %}
                        {% endwith %}
                    </div>
                {% empty %}
                    <p>등록된 결과가 없습니다.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
