{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static "admin/css/forms.css" %}">
<style>
    .filters-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
        align-items: flex-end;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .filter-group select, .filter-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        height: 38px;
        box-sizing: border-box;
    }
    
    .filter-buttons {
        display: flex;
        gap: 10px;
    }
    
    .filter-buttons button {
        padding: 9px 15px;
        background-color: #79aec8;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .filter-buttons button:hover {
        background-color: #417690;
    }
    
    .content-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .content-table th, .content-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    .content-table th {
        background-color: #f5f5f5;
        font-weight: bold;
    }
    
    .content-table tr:hover {
        background-color: #f9f9f9;
    }
    
    .content-table td a {
        color: #417690;
        text-decoration: none;
    }
    
    .content-table td a:hover {
        text-decoration: underline;
    }
    
    .chart-container {
        margin-top: 30px;
        height: 400px;
    }
    
    .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 2s linear infinite;
        margin: 20px auto;
        display: none;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .no-data {
        text-align: center;
        padding: 20px;
        color: #888;
    }
    
    .back-button {
        margin-bottom: 20px;
    }
    
    .back-button a {
        color: #417690;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
    }
    
    .back-button a:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <div class="back-button">
        <a href="{% url 'analytics:admin_views_stats' %}">
            <span style="margin-right: 5px;">←</span> 전체 조회수 분석으로 돌아가기
        </a>
    </div>
    
    <h1>{{ app_label }} 콘텐츠 조회수 분석</h1>
    
    <div class="filters-container">
        <div class="filter-group">
            <label for="limit">상위 표시 개수</label>
            <select id="limit">
                <option value="10">10개</option>
                <option value="20">20개</option>
                <option value="50">50개</option>
                <option value="100">100개</option>
            </select>
        </div>
        
        <div class="filter-buttons">
            <button id="apply-filters">적용</button>
        </div>
    </div>
    
    <div id="loader" class="loader"></div>
    
    <div class="chart-container">
        <canvas id="contentChart"></canvas>
    </div>
    
    <h2>콘텐츠별 조회수 순위</h2>
    
    <table class="content-table" id="contentTable">
        <thead>
            <tr>
                <th>순위</th>
                <th>제목</th>
                <th>조회수</th>
                <th>생성일</th>
                {% if app_name == 'post' %}
                <th>카테고리</th>
                {% endif %}
                <th>관리</th>
            </tr>
        </thead>
        <tbody id="contentTableBody">
            <tr>
                <td colspan="{% if app_name == 'post' %}6{% else %}5{% endif %}" class="no-data">
                    데이터를 불러오는 중...
                </td>
            </tr>
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 차트 객체
        let contentChart = null;
        
        // 필터 적용 버튼 클릭 이벤트
        document.getElementById('apply-filters').addEventListener('click', fetchData);
        
        // 데이터 가져오기
        function fetchData() {
            // 로딩 표시 시작
            document.getElementById('loader').style.display = 'block';
            document.getElementById('contentTableBody').innerHTML = '<tr><td colspan="{% if app_name == 'post' %}6{% else %}5{% endif %}" class="no-data">데이터를 불러오는 중...</td></tr>';
            
            // 필터 값 가져오기
            const limit = document.getElementById('limit').value;
            
            // API 요청
            fetch(`/analytics/api/content-data/{{ app_name }}/?limit=${limit}`)
                .then(response => response.json())
                .then(data => {
                    // 로딩 표시 종료
                    document.getElementById('loader').style.display = 'none';
                    
                    // 차트 업데이트
                    updateChart(data.content_data);
                    
                    // 테이블 업데이트
                    updateTable(data.content_data);
                })
                .catch(error => {
                    console.error('데이터 가져오기 오류:', error);
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('contentTableBody').innerHTML = '<tr><td colspan="{% if app_name == 'post' %}6{% else %}5{% endif %}" class="no-data">데이터를 가져오는 중 오류가 발생했습니다.</td></tr>';
                });
        }
        
        // 차트 업데이트
        function updateChart(contentData) {
            const ctx = document.getElementById('contentChart').getContext('2d');
            
            // 기존 차트 제거
            if (contentChart) {
                contentChart.destroy();
            }
            
            // 데이터가 없는 경우
            if (!contentData || contentData.length === 0) {
                document.getElementById('contentTableBody').innerHTML = '<tr><td colspan="{% if app_name == 'post' %}6{% else %}5{% endif %}" class="no-data">데이터가 없습니다.</td></tr>';
                return;
            }
            
            // 차트 데이터 준비
            const labels = contentData.map(item => item.title);
            const views = contentData.map(item => item.views);
            
            // 차트 색상
            let backgroundColor = [];
            let borderColor = [];
            
            if ('{{ app_name }}' === 'psycho') {
                backgroundColor = 'rgba(75, 192, 192, 0.5)';
                borderColor = 'rgba(75, 192, 192, 1)';
            } else if ('{{ app_name }}' === 'face') {
                backgroundColor = 'rgba(153, 102, 255, 0.5)';
                borderColor = 'rgba(153, 102, 255, 1)';
            } else if ('{{ app_name }}' === 'post') {
                backgroundColor = 'rgba(255, 159, 64, 0.5)';
                borderColor = 'rgba(255, 159, 64, 1)';
            }
            
            // 새 차트 생성
            contentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '조회수',
                        data: views,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '조회수'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '콘텐츠'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    // 긴 제목 자르기
                                    const label = this.getLabelForValue(value);
                                    if (label.length > 20) {
                                        return label.substr(0, 17) + '...';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: '{{ app_label }} 조회수 순위 TOP ' + contentData.length
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    // 전체 제목 표시
                                    return tooltipItems[0].label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 테이블 업데이트
        function updateTable(contentData) {
            const tableBody = document.getElementById('contentTableBody');
            tableBody.innerHTML = '';
            
            if (!contentData || contentData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="{% if app_name == 'post' %}6{% else %}5{% endif %}" class="no-data">데이터가 없습니다.</td></tr>';
                return;
            }
            
            contentData.forEach((item, index) => {
                const row = document.createElement('tr');
                
                const rankCell = document.createElement('td');
                rankCell.textContent = index + 1;
                row.appendChild(rankCell);
                
                const titleCell = document.createElement('td');
                titleCell.textContent = item.title;
                row.appendChild(titleCell);
                
                const viewsCell = document.createElement('td');
                viewsCell.textContent = item.views;
                row.appendChild(viewsCell);
                
                const dateCell = document.createElement('td');
                dateCell.textContent = item.created_at;
                row.appendChild(dateCell);
                
                {% if app_name == 'post' %}
                const categoryCell = document.createElement('td');
                categoryCell.textContent = item.category || '-';
                row.appendChild(categoryCell);
                {% endif %}
                
                const actionCell = document.createElement('td');
                const link = document.createElement('a');
                link.href = item.url;
                link.textContent = '보기';
                actionCell.appendChild(link);
                row.appendChild(actionCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // 초기 데이터 로드
        fetchData();
    });
</script>
{% endblock %}